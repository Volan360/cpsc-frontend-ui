<div class="header-actions">
  <button mat-icon-button (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span class="spacer"></span>
  <button 
    mat-raised-button 
    class="complete-button" 
    (click)="completeGoal()"
    *ngIf="goal && goal.targetAmount && calculateCurrentAmount() >= goal.targetAmount && goal.isActive !== false"
    [disabled]="loading">
    <mat-icon>check_circle</mat-icon>
    <span class="button-text">Complete Goal</span>
  </button>
  <button mat-raised-button color="primary" (click)="editGoal()" class="edit-button" *ngIf="goal?.isActive !== false">
    <mat-icon>edit</mat-icon>
    <span class="button-text">Edit Goal</span>
  </button>
  <button mat-raised-button color="warn" (click)="deleteGoal()" class="delete-button">
    <mat-icon>delete</mat-icon>
    <span class="button-text">Delete Goal</span>
  </button>
</div>

<div *ngIf="loading" class="loading-container">
  <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
</div>

<div *ngIf="!loading && goal">
  <mat-card class="goal-summary">
    <mat-card-header>
      <mat-card-title>{{ goal.name }}</mat-card-title>
      <mat-card-subtitle>
        Created {{ formatDate(goal.createdAt) }}
        <span *ngIf="goal.completedAt"> â€¢ Completed {{ formatDate(goal.completedAt * 1000) }}</span>
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="description" *ngIf="goal.description">
        <p>{{ goal.description }}</p>
      </div>

      <div class="status-chip">
        <mat-chip [class]="'status-' + getGoalStatus()">
          {{ getStatusLabel() }}
        </mat-chip>
      </div>

      <div class="goal-progress">
        <div class="progress-header">
          <div class="progress-label">
            <span class="label">Current Amount:</span>
            <span class="value current">{{ formatCurrency(calculateCurrentAmount()) }}</span>
          </div>
          <div class="progress-label" *ngIf="goal.targetAmount">
            <span class="label">Target Amount:</span>
            <span class="value target">{{ formatCurrency(goal.targetAmount) }}</span>
          </div>
        </div>

        <div class="progress-bar" *ngIf="goal.targetAmount">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
        </div>

        <div class="progress-percentage" *ngIf="goal.targetAmount">
          {{ getProgressPercentage().toFixed(1) }}% Complete
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="linked-institutions-card" *ngIf="goal.isActive !== false">
    <mat-card-header>
      <mat-card-title>Linked Institutions</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div *ngIf="!goal.linkedInstitutions || getLinkedInstitutionsKeys().length === 0" class="empty-state">
        <mat-icon>account_balance</mat-icon>
        <p>No institutions linked to this goal</p>
      </div>

      <div class="institutions-list" *ngIf="goal.linkedInstitutions && getLinkedInstitutionsKeys().length > 0">
        <div class="institution-item" 
             *ngFor="let entry of goal.linkedInstitutions | keyvalue"
             (click)="navigateToInstitution(entry.key)">
          <div class="institution-info">
            <div class="institution-header">
              <span class="institution-name">{{ getInstitution(entry.key)?.institutionName || 'Unknown Institution' }}</span>
              <mat-chip class="percentage-chip">{{ entry.value }}%</mat-chip>
            </div>
            <div class="institution-details">
              <div class="detail-row">
                <span class="detail-label">Current Balance:</span>
                <span class="detail-value">{{ formatCurrency(getInstitution(entry.key)?.currentBalance || 0) }}</span>
              </div>
              <div class="detail-row allocated">
                <span class="detail-label">Allocated to this Goal:</span>
                <span class="detail-value">{{ formatCurrency(calculateAllocatedAmount(entry.key, entry.value)) }}</span>
              </div>
            </div>
          </div>
          <mat-icon class="chevron-icon">chevron_right</mat-icon>
        </div>
      </div>

      <div class="total-summary" *ngIf="goal.linkedInstitutions && getLinkedInstitutionsKeys().length > 0">
        <div class="summary-row">
          <span class="summary-label">Total from All Institutions:</span>
          <span class="summary-value">{{ formatCurrency(calculateCurrentAmount()) }}</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Linked Transactions for Completed Goals -->
  <mat-card class="linked-transactions-card" *ngIf="goal.isActive === false && linkedTransactions.length > 0">
    <mat-card-header>
      <mat-card-title>Goal Completion Transactions</mat-card-title>
      <mat-card-subtitle>These withdrawal transactions were made when this goal was completed</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="transactions-list">
        <div class="transaction-item" 
             *ngFor="let transaction of linkedTransactions"
             (click)="navigateToTransactionInstitution(transaction)">
          <div class="transaction-main">
            <div class="transaction-header">
              <mat-icon class="transaction-icon">receipt</mat-icon>
              <span class="transaction-amount">{{ formatCurrency(transaction.amount) }}</span>
              <mat-chip class="type-chip withdrawal">WITHDRAWAL</mat-chip>
            </div>
            <div class="transaction-details">
              <div class="detail-row" *ngIf="transaction.description">
                <mat-icon class="detail-icon">description</mat-icon>
                <span class="detail-text">{{ transaction.description }}</span>
              </div>
              <div class="detail-row">
                <mat-icon class="detail-icon">account_balance</mat-icon>
                <span class="detail-text">{{ getTransactionInstitution(transaction)?.institutionName || 'Unknown Institution' }}</span>
              </div>
              <div class="detail-row">
                <mat-icon class="detail-icon">calendar_today</mat-icon>
                <span class="detail-text">{{ formatDate(transaction.transactionDate * 1000) }}</span>
              </div>
              <div class="detail-row tags-row" *ngIf="transaction.tags && transaction.tags.length > 0">
                <mat-icon class="detail-icon">label</mat-icon>
                <div class="tags-container">
                  <mat-chip *ngFor="let tag of transaction.tags" class="tag-chip">{{ tag }}</mat-chip>
                </div>
              </div>
            </div>
          </div>
          <mat-icon class="chevron-icon">chevron_right</mat-icon>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
