<div class="header-actions">
  <button mat-icon-button (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span class="spacer"></span>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="completeGoal()"
    *ngIf="goal && goal.targetAmount && calculateCurrentAmount() >= goal.targetAmount"
    [disabled]="loading">
    <mat-icon>check_circle</mat-icon>
    Complete Goal
  </button>
  <button mat-raised-button color="warn" (click)="deleteGoal()">
    <mat-icon>delete</mat-icon>
    Delete Goal
  </button>
</div>

<div *ngIf="loading" class="loading-container">
  <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
</div>

<div *ngIf="!loading && goal">
  <mat-card class="goal-summary">
    <mat-card-header>
      <mat-card-title>{{ goal.name }}</mat-card-title>
      <mat-card-subtitle>Created {{ formatDate(goal.createdAt) }}</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="description" *ngIf="goal.description">
        <p>{{ goal.description }}</p>
      </div>

      <div class="status-chip">
        <mat-chip [class]="'status-' + getGoalStatus()">
          {{ getStatusLabel() }}
        </mat-chip>
      </div>

      <div class="goal-progress">
        <div class="progress-header">
          <div class="progress-label">
            <span class="label">Current Amount:</span>
            <span class="value current">{{ formatCurrency(calculateCurrentAmount()) }}</span>
          </div>
          <div class="progress-label" *ngIf="goal.targetAmount">
            <span class="label">Target Amount:</span>
            <span class="value target">{{ formatCurrency(goal.targetAmount) }}</span>
          </div>
        </div>

        <div class="progress-bar" *ngIf="goal.targetAmount">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
        </div>

        <div class="progress-percentage" *ngIf="goal.targetAmount">
          {{ getProgressPercentage().toFixed(1) }}% Complete
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="linked-institutions-card">
    <mat-card-header>
      <mat-card-title>Linked Institutions</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div *ngIf="!goal.linkedInstitutions || getLinkedInstitutionsKeys().length === 0" class="empty-state">
        <mat-icon>account_balance</mat-icon>
        <p>No institutions linked to this goal</p>
      </div>

      <div class="institutions-list" *ngIf="goal.linkedInstitutions && getLinkedInstitutionsKeys().length > 0">
        <div class="institution-item" *ngFor="let entry of goal.linkedInstitutions | keyvalue">
          <div class="institution-info">
            <div class="institution-header">
              <a class="institution-name" (click)="navigateToInstitution(entry.key)">{{ getInstitution(entry.key)?.institutionName || 'Unknown Institution' }}</a>
              <mat-chip class="percentage-chip">{{ entry.value }}%</mat-chip>
            </div>
            <div class="institution-details">
              <div class="detail-row">
                <span class="detail-label">Current Balance:</span>
                <span class="detail-value">{{ formatCurrency(getInstitution(entry.key)?.currentBalance || 0) }}</span>
              </div>
              <div class="detail-row allocated">
                <span class="detail-label">Allocated to this Goal:</span>
                <span class="detail-value">{{ formatCurrency(calculateAllocatedAmount(entry.key, entry.value)) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="total-summary" *ngIf="goal.linkedInstitutions && getLinkedInstitutionsKeys().length > 0">
        <div class="summary-row">
          <span class="summary-label">Total from All Institutions:</span>
          <span class="summary-value">{{ formatCurrency(calculateCurrentAmount()) }}</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
